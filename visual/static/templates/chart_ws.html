{{#*inline "page"}}
<!--<!DOCTYPE html>-->
<!--<html>-->
<!--  <head>-->
<!--    <meta charset="utf-8" />-->
<!--    <title>Chat!</title>-->

<div><canvas id="chart_0"></canvas><br></div>
<script src="/js/chart.js"></script>
<script src="/js/chartjs-adapter-date-fns.js"></script>


<br>






    <style>
      /*:root {*/
      /*  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,*/
      /*    Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;*/
      /*  font-size: 18px;*/
      /*}*/

      input[type='text'] {
        font-size: inherit;
      }

      #log {
        width: 30em;
        height: 20em;
        overflow: auto;
        margin: 0.5em 0;

        border: 1px solid black;
      }

      #status {
        padding: 0 0.2em;
      }

      #text {
        width: 17em;
        padding: 0.5em;
      }

      .msg {
        margin: 0;
        padding: 0.25em 0.5em;
      }

      .msg--status {
        /* a light yellow */
        background-color: #ffffc9;
      }

      .msg--message {
        /* a light blue */
        background-color: #d2f4ff;
      }

      .msg--error {
        background-color: pink;
      }
    </style>
<!--  </head>-->
<!--  <body>-->
    <h1>Chat!</h1>

    <div>
      <button id="connect">Connect</button>
      <span>Status:</span>
      <span id="status">disconnected</span>
    </div>

    <div id="log"></div>

    <form id="chatform">
      <input type="text" id="text" />
      <input type="submit" id="send" />
    </form>

    <hr />

    <section>
      <h2>Commands</h2>
      <table style="border-spacing: 0.5em">
        <tr>
          <td>
            <code>/list</code>
          </td>
          <td>list all available rooms</td>
        </tr>
        <tr>
          <td>
            <code>/join name</code>
          </td>
          <td>join room, if room does not exist, create new one</td>
        </tr>
        <tr>
          <td>
            <code>/name name</code>
          </td>
          <td>set session name</td>
        </tr>
        <tr>
          <td>
            <code>some message</code>
          </td>
          <td>just string, send message to all peers in same room</td>
        </tr>
      </table>
    </section>

<script>

/*
[{"label":"btc_usd","data":[{"x":"2023-12-24T20:00:48.809965Z","y":43632.47}]},{"label":"btc_usd_MovingAvg0004","data":[{"x":"2023-12-24T20:00:48.809965Z","y":43631.175}]},{"label":"btc_usd_MovingAvg0010","data":[{"x":"2023-12-24T20:00:48.809965Z","y":43631.20857142857}]},{"label":"btc_usd_MovingAvg0100","data":[{"x":"2023-12-24T20:00:48.809965Z","y":43640.97965517244}]},{"label":"btc_usd_MovingAvg1000","data":[{"x":"2023-12-24T20:00:48.809965Z","y":43642.78674698797}]}]
*/

let data_map = new Map();
let chart=null;


const $status = document.querySelector('#status')
const $connectButton = document.querySelector('#connect')
const $log = document.querySelector('#log')
const $form = document.querySelector('#chatform')
const $input = document.querySelector('#text')

/** @type {WebSocket | null} */
var socket = null

function log(msg, type = 'status') {
    $log.innerHTML += `<p class="msg msg--${type}">${msg}</p>`
    $log.scrollTop += 1000
}
function connect() {
    disconnect()
    const { location } = window
    // const proto = location.protocol.startsWith('https') ? 'wss' : 'ws'
    // const wsUri = `${proto}://${location.host}/ws`
    const wsUri = "ws://127.0.0.1:3012"
    log('Connecting...')
    socket = new WebSocket(wsUri);

    socket.onopen = () => {
        log('Connected')
        updateConnectionStatus()
    }

    socket.onmessage = (ev) => {
        let json = JSON.parse(ev.data);
        log('Raw: ' + ev.data, 'message')

        for (var i in json) {
            log('raw: ' + json[i].label, '');

            let curr_label = json[i].label;
            let xy_array = json[i].data;

            console.log("curr_label: " + curr_label);
            console.log("xy len: " + xy_array.length);
            for(var j in xy_array) {

                console.log("xy: " + xy_array[j].x);
                console.log("xy: " + xy_array[j].y);
            }

            if(!curr_label.startsWith("eth")) {
                if (xy_array.length > 0) {

                    if (data_map.has(curr_label)) {
                        // get data array
                        let old_dataset = data_map.get(curr_label);
                        old_dataset.data.push(xy_array);
                        // let dataset = {
                        //     label: curr_label,
                        //     data: old_dataset.y
                        // };
                        data_map.set(curr_label, old_dataset);
                        console.log("[0] total " + curr_label + ": " + data_map.get(curr_label).data.length)
                    } else {
                        // create
                        let dataset = {
                            label: json[i].label,
                            data: xy_array
                        };
                        data_map.set(curr_label, dataset);
                        console.log("[1] total " + curr_label + ": " + data_map.get(curr_label).data.length)
                    }

                    display_chart();

                }
            }
        }
    }

    socket.onclose = () => {
        log('Disconnected')
        socket = null
        updateConnectionStatus()
    }

}

// function addData(newData) {
//   // chart.data.labels.push(label);
//   chart.data.datasets.forEach((dataset) => {
//       dataset.data.push(newData);
//   });
//   chart.update();
// }

function display_chart() {



    let dmap_array_value = data_map.values();
    for (j of dmap_array_value) {
        console.log("dmap_array value: " + j.label);

        let dataset = data_map.get(j.label);

        console.log(dataset.label);
        console.log(dataset.data.length);


    }

    // console.log("dmap_array: " + dmap_array);
    // for(var i in dmap_array) {
    //     console.log("dmap_array: " + dmap_array[i].label);
    //     console.log("dmap_array x: " + dmap_array[i].x);
    //     console.log("dmap_array y: " + dmap_array[i].y);
    //
    // }


    if(!chart) {

        let ctx = document.getElementById('chart_0').getContext('2d');
        let chart_title = '{{chart_title}}';
        chart = new Chart(ctx, {
            type: 'line',
            // data: { datasets: [s1, s2] },
            data: {datasets: Array.from(data_map.values())},
            options: {
                animation: {
                    duration: 0
                },
                responsive: true,   // resize to fit browser window
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: chart_title
                    }
                },
                scales: {
                    x: {
                        type: 'time'
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                    },
                }
            }
        });
    } else {
        chart.clear();
        chart.destroy();

        let ctx = document.getElementById('chart_0').getContext('2d');
        let chart_title = '{{chart_title}}';
        chart = new Chart(ctx, {
            type: 'line',
            // data: { datasets: [s1, s2] },
            data: {datasets: Array.from(data_map.values())},
            options: {
                animation: {
                    duration: 0
                },
                responsive: true,   // resize to fit browser window
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: chart_title
                    }
                },
                scales: {
                    x: {
                        type: 'time'
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                    },
                }
            }
        });
    }



}

function disconnect() {
    if (socket) {
        log('Disconnecting...')
        socket.close()
        socket = null

        updateConnectionStatus()
    }
}

function updateConnectionStatus() {
    if (socket) {
        $status.style.backgroundColor = 'transparent'
        $status.style.color = 'green'
        $status.textContent = `connected`
        $connectButton.innerHTML = 'Disconnect'
        $input.focus()
    } else {
        $status.style.backgroundColor = 'red'
        $status.style.color = 'white'
        $status.textContent = 'disconnected'
        $connectButton.textContent = 'Connect'
    }
}

$connectButton.addEventListener('click', () => {
    if (socket) {
        disconnect()
    } else {
        connect()
    }

    updateConnectionStatus()
})
$form.addEventListener('submit', (ev) => {
    ev.preventDefault()

    const text = $input.value

    log('Sending: ' + text)
    socket.send(text)

    $input.value = ''
    $input.focus()
})

updateConnectionStatus()

display_chart();

</script>






<!--  </body>-->
<!--</html>-->
{{/inline}}
{{> (lookup this "parent")}}